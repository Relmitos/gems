<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Chain it! Or data pipelining with Python - Gems</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Gems</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Python <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../python/design-patterns/" class="dropdown-item">Design Patterns</a>
</li>
                                    
<li>
    <a href="../../python/tdd/" class="dropdown-item">Test Driven Development (TDD)</a>
</li>
                                    
<li>
    <a href="../../python/kata/" class="dropdown-item">Kata</a>
</li>
                                    
<li>
    <a href="../../python/tricks/" class="dropdown-item">Tricks</a>
</li>
                                    
<li>
    <a href="../../python/misc/" class="dropdown-item">Misc Python Topics</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Other <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../sqlserver/" class="dropdown-item">SQL Server</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../" class="nav-link">Blog</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#chain-it-or-data-pipelining-with-python" class="nav-link">Chain it! Or data pipelining with Python</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="chain-it-or-data-pipelining-with-python">Chain it! Or data pipelining with Python</h1>
<p><img alt="pipeline" src="../img/pipeline.jpg" /></p>
<p>Recently I worked on a data processing pipeline. A bunch of source systems deliver files into a staging folder. An agent, written in Python, is monitoring the staging folder and is processing all the files from the folder, extracting the words and and loading them into a database. </p>
<p>We could easily end up with something like:</p>
<pre><code class="python">while True:
    for file_list in ls_files(STAGING_PATH):
        for file_name in itertools.chain.from_iterable(file_list):
            for file in open(os.path.join(STAGING_PATH, fn), file_name):
                for line in file:
                    line_prepared = re_non_alpha_characters.sub(' ', l).lower()
                    words = line_prepared.split(' ')
                    for word in words:
                        save_word(word.strip())
    finish_batch()
</code></pre>

<p>Nice, isn't?</p>
<p>But - not easy to read and understand. How about testing?</p>
<p>Where and how should I add exception handling? What about files - who is going to close them and when? How I can add new functionality, e.g. extract text from PDF files or images or automatic language translation? How we could accommodate business logic - e.g. search for similar words with Levenshtein distance, bucket words in categories, etc. How could multiple developers work on this solution? Well ... This one is easy and quick to start, but quickly becomes messy.</p>
<p>To address these concerns I was aiming at expressive, flexible, testable and extensible code.</p>
<p>First thing was to refactor the code in a way to remove the nesting of the statements. The <code>main()</code> function of the agent looks now very simple:</p>
<pre><code class="python">def main():
    for word in build_word_pipeline():
        save_word(word)
</code></pre>

<p>The <code>build_word_pipeline()</code> function is:</p>
<pre><code class="python">def build_word_pipeline():
    batch_source = after_it(finish_batch, repeater(get_batch))
    file_names = flat_map(None, batch_source)
    file_names_with_path = map(lambda fn: os.path.join(STAGING_PATH, fn), file_names)
    lines = flat_map(get_file_lines, file_names_with_path)
    words = flat_map(lambda l: re_non_alpha_characters.sub(' ', l).lower().split(' '), lines)
    words = filter(lambda w: len(w) &gt; 0, words)
    words = map(lambda w: w.lower().strip(), words)
    return words
</code></pre>

<p>A few words about the functions used in this snippet:</p>
<ul>
<li><code>repeater</code> converts a function result into a collection by calling the function repeatedly.</li>
<li><code>after_it</code> decorates a collection so that a given function (<code>after_batch</code>) is called each time after an item from the input collection is consumed.</li>
<li><code>finish_batch</code> performs a clean up operations and is suspending the execution for a given duration in seconds.</li>
<li><code>flat_map</code> applies a collection returning mapper function to input collection and is flattening the result by placing each item from the result collections into the output.</li>
<li><code>filter</code> is a standard Python function for filtering a collection.</li>
<li><code>map</code> is a standard Python function for applying a function to each element from a collection. </li>
<li><code>re_non_alpha_characters</code> is a regular expression for finding non alpha characters.</li>
</ul>
<p>All above functions are lazy and work through Python generators and iterators.</p>
<p>And I can easily write unit tests for this code.</p>
<p>Looking at the result code, I was thinking - how I can make it more readable and easy to understand?</p>
<p>First thing would be to convert lambdas to regular functions with meaningful names.</p>
<pre><code class="python">def build_word_pipeline():
    batch_sorce = repeater(get_batch)
    batches_with_after = after_it(finish_batch, batch_sorce)
    file_names = flat_map(None, batch_source)
    file_names_with_path = map(make_path, file_names)
    lines = flat_map(get_file_lines, file_names_with_path)
    words = flat_map(split_into_words, lines)
    words = filter(None, words)
</code></pre>

<p>I think it is better now. I have to issues with this:</p>
<ul>
<li>I find it difficult to name all the intermediate steps</li>
<li>There is a lot of repetition. The collection variable from the previous line is used as argument in the next line. This is like moving water with buckets - Fill the bucket at left side, bring it to the right side, empty it in the processing unit and go back to the right with the empty bucket for the next task.</li>
</ul>
<p>Could we address these two issues? What I was looking for is:</p>
<script src="https://gist.github.com/ivangeorgiev/b5b187432359384cb9f1eb8d4df4509e.js"></script>

<p>The solution is in the decorator pattern. We start with a collection wrapped into a decorator <code>Pipe</code>. Than we apply a transformation which returns another <code>Pipe</code> decorator which bundles also the transformation. And we continue until we get all the processing we need defined.</p>
<p>Here is the source for the <code>Pipe</code> class:</p>
<script src="https://gist.github.com/ivangeorgiev/a6b3d6dc458391a38e693af7aba7a99c.js"></script>

<p>In the implementation there is one addition - the <code>before</code>  method which calls a function before the next item from the collection is returned. The same effect could be achieved using <code>map</code>, but I added it for symmetry with <code>after</code> method and as syntactic sugar.</p>
<p>Think about following. Using the Pipe approach, can you make the solution configuration driven? Can you turn on or off stages, using feature flags?</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
